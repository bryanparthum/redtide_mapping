---
title: "The Value of Information and Warnings about Harmful Algal Blooms"
author: "Klaus Moeltner, Zhenyu Yao, Bryan Parthum"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: yes
    depth: 2
    number_sections: true
    code_folding:  hide
editor_options: 
  chunk_output_type: console
---

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(memisc)
library(gmnl)
library(kableExtra)
library(tidyverse)
library(magrittr)
library(qpcR)
```

<!-- <style type="text/css"> -->
<!--   body{font-size: 0.5em} -->
<!-- caption {font-size: 1.0em} -->
<!-- </style> -->

# Summary

This document provides an overview of the estimation for the Red Tide Mapping project, and the motivation behind each specification. The models are estimated in [Rstudio](https://rstudio.com/), an open source platform using the [-gmnl-](https://www.jstatsoft.org/article/view/v079i02) package (Sarrias and Daziano, 2017). 

# Methods

# Summary Statistics

<br>

# Preference Space Models

We first estimate the model using a simple multinomial logit (MNL). We then introduce the random parameter model (MXL) with both uncorrelated random parameters and fully correlated. We assume the distribution on _bid_ is fixed in order to derive subsequent empirical distributions of willingness to pay (WTP) using the delta method. This means that the marginal utility of money is uniform across respondents.

```{r message=FALSE, warning=FALSE, echo=FALSE}
## LOAD NULL MODEL
null_model <- readRDS("../output/estimates/null_model.rds")

## LOAD PREFERENCE SPACE MODELS
pref_clogit         <- readRDS("../output/estimates/pref_clogit.rds")
pref_uncorr         <- readRDS("../output/estimates/pref_uncorr.rds")
pref                <- readRDS("../output/estimates/pref.rds")
```


```{r }
## Export
getSummary <- getSummary.gmnl

mtable("C-logit"=pref_clogit,"MXL Uncorrelated"=pref_uncorr,"MXL Correlated"=pref,
                    digits=3,
                    summary.stats = c("N","Log-likelihood","AIC",'BIC')) %>%
  relabel(.,sq = "Status-Quo",
        cov12 = "Coverage: 12 Miles",
        acc175 = "Accuracy 1: 75%",
        acc1100 = "Accuracy 1: 100%",
        acc275 = "Accuracy 2: 75%",
        acc2100 = "Accuracy 2: 100%",
        bid = 'Cost')
```

<br>

Model fit according to McFadden pseudo $\rho^2$: $1-\frac{LL_{full}}{LL_{null}}$

``` {r}
mcfad_r2 <- function(x,y) {round(1-(as.numeric(logLik(x))/as.numeric(logLik(y))),2)}
pref_clogit_r2 <- mcfad_r2(pref_clogit,null_model)
pref_uncorr_r2 <- mcfad_r2(pref_uncorr,null_model)
pref_r2        <- mcfad_r2(pref,null_model)

data.frame(row.names = 'McFadden \\(\\rho^2\\)',
          "MNL"=pref_clogit_r2,"MXL Uncorrelated"=pref_uncorr_r2,"MXL Correlated"=pref_r2) %>%
    kbl() %>% kable_classic(full_width = FALSE)
```

<br>

## Willingness to Pay

``` {r}
## LOAD PREFERENCE SPACE WTP 
pref_clogit_wtp         <- readRDS("../output/estimates/pref_clogit_wtp.rds")
pref_uncorr_wtp         <- readRDS("../output/estimates/pref_uncorr_wtp.rds") 
pref_wtp                <- readRDS("../output/estimates/pref_wtp.rds")

stars <- function(x) {ifelse(x[,4]<=0.001,'***',ifelse(x[,4]<=0.01 & x[,4]>0.001,'**',ifelse(x[,4]<=0.05 & x[,4]>0.01,'*','')))}

ci <- function(x,y) {paste0('[', round(x-(1.96*y[,2]),2), ', ', round(x+(1.96*y[,2]),2),']')}

pref_clogit_wtp %<>% as.data.frame() %>% slice(1:6) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MNL'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(1,3)

pref_uncorr_wtp %<>% as.data.frame() %>% slice(1:6) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MXL Uncorrelated'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(3)

pref_wtp %<>% as.data.frame() %>% slice(1:6) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MXL Correlated'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(3)

wtp <- cbind(pref_clogit_wtp,pref_uncorr_wtp,pref_wtp) %>% 
       mutate(Attribute = c("Status-Quo","","Coverage: 12 Miles","","Accuracy 1: 75%","","Accuracy 1: 100%","","Accuracy 2: 75%","","Accuracy 2: 100%",""))

kable(wtp, caption='Willingness to Pay from Preference-Space',booktabs = TRUE, align = c('l','c','c','c')) %>% kable_classic() %>% kable_styling(font_size = 16) %>%
  footnote('95% confidence intervals in brackets derived using the delta method. \\(^{*}\\)p<0.1; \\(^{**}\\)p<0.05; \\(^{***}\\)p<0.01',footnote_as_chunk = T)
```

## Preference Heterogeneity

We introduce preference heterogeneity by interacting past environmental observations at the three nearest beaches to each respondent's recorded zip code (inverse gravity distance weighting). These are averages for 2019 and the one month prior to when the respondent took the survey. 

- Water color:
  - 1 = Clear. Able to see the bottom in shallow water.
  - 2 = Moderate. A light tint.
  - 3 = Dark. Thick or murky water.
  
- Respiratory irritation: 
  - 1 = None. No coughing observed due to airborne toxins.
  - 2 = Slight. A few coughs/sneezes heard in 30 seconds.
  - 3 = Moderate. A cough/sneeze heard every 5 seconds.
  - 4 = High. Coughing/sneezing heard almost continuously.
  
All models assume fully correlated random parameters, with _bid_ fixed. 
  
```{r message=FALSE, warning=FALSE, echo=FALSE}

## LOAD PREFERENCE SPACE MODELS
pref      <- readRDS("../output/estimates/pref.rds")
pref_het_water      <- readRDS("../output/estimates/pref_het_water.rds")
pref_het_water_resp <- readRDS("../output/estimates/pref_het_water_resp.rds")
```


```{r }
## Export

mtable("MXL"=pref,"MXL Water Color"=pref_het_water,"MXL Water and Respiratory"=pref_het_water_resp,
                    digits=3,
                    summary.stats = c("N","Log-likelihood","AIC",'BIC')) %>%
  relabel(.,sq = "Status-Quo",
        cov12 = "Coverage: 12 Miles",
        acc175 = "Accuracy 1: 75%",
        acc1100 = "Accuracy 1: 100%",
        acc275 = "Accuracy 2: 75%",
        acc2100 = "Accuracy 2: 100%",
        sq_watercolor2019 = 'Mean Water Clarity 2019',
        sq_watercolor_1m  = 'Mean Water Clarity 1 Month',
        sq_respirr2019  = 'Mean Respiratory Quality 2019',
        sq_respirr_1m  = 'Mean Respiratory Quality 1 Month')
```

<br>

Model fit according to McFadden pseudo $\rho^2$: $1-\frac{LL_{full}}{LL_{null}}$

``` {r}
pref_r2        <- mcfad_r2(pref,null_model)
pref_het_water_r2        <- mcfad_r2(pref_het_water,null_model)
pref_het_water_resp_r2        <- mcfad_r2(pref_het_water_resp,null_model)


data.frame(row.names = 'McFadden \\(\\rho^2\\)',
          "MXL Correlated"=pref_r2,"MXL Water Color"=pref_het_water_r2,"MXL Water and Respiratory"=pref_het_water_resp_r2) %>%
    kbl() %>% kable_classic(full_width = FALSE)
```

<br>

## Willingness to Pay

``` {r}
## LOAD PREFERENCE SPACE WTP 
pref_wtp                <- readRDS("../output/estimates/pref_wtp.rds")
pref_het_water_wtp      <- readRDS("../output/estimates/pref_het_water_wtp.rds")
pref_het_water_resp_wtp <- readRDS("../output/estimates/pref_het_water_resp_wtp.rds")

stars <- function(x) {ifelse(x[,4]<=0.001,'***',ifelse(x[,4]<=0.01 & x[,4]>0.001,'**',ifelse(x[,4]<=0.05 & x[,4]>0.01,'*','')))}

ci <- function(x,y) {paste0('[', round(x-(1.96*y[,2]),2), ', ', round(x+(1.96*y[,2]),2),']')}

pref_wtp %<>% as.data.frame() %>% slice(1:6) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MXL Correlated'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(1,3)

pref_het_water_wtp %<>% as.data.frame() %>% slice(1:8) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MXL Water Color'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(3)

pref_het_water_resp_wtp %<>% as.data.frame() %>% slice(1:10) %>%
                     mutate(Estimate = Estimate*-1,
                            stars = stars(.),
                            CI = ci(Estimate,.),
                            WTP = paste0(round(Estimate,2),stars),
                            Attribute = rownames(.)) %>%
                     select(Attribute,WTP,CI) %>%
                     pivot_longer(WTP:CI) %>%
                     rename('MXL Water and Respiratory'=value) %>%
                     mutate(Attribute = ifelse(name=='CI','',Attribute)) %>%
                     select(3)

wtp <- qpcR:::cbind.na(pref_wtp,pref_het_water_wtp,pref_het_water_resp_wtp) %>% 
       mutate(Attribute = c("Status-Quo","","Coverage: 12 Miles","","Accuracy 1: 75%","","Accuracy 1: 100%","","Accuracy 2: 75%","","Accuracy 2: 100%","","Mean Water Clarity 2019","","Mean Water Clarity 1 Month","","Mean Respiratory Quality 2019","","Mean Respiratory Quality 1 Month",""))
wtp[is.na(wtp)] <- " "

kable(wtp, caption='Willingness to Pay from Preference-Space',booktabs = TRUE, align = c('l','c','c','c')) %>% kable_classic() %>% kable_styling(font_size = 16) %>%
  footnote('95% confidence intervals in brackets derived using the delta method. \\(^{*}\\)p<0.1; \\(^{**}\\)p<0.05; \\(^{***}\\)p<0.01',footnote_as_chunk = T)
```
